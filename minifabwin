@echo off

wsl -- ls /run/WSL > NUL: 2 > NUL:
IF %ERRORLEVEL% EQU 0 (
  echo "You have WSL2 installed - please use the instructions for Linux"
) ELSE (

  setlocal
  setlocal enabledelayedexpansion

  SET _alladdress=
  for /f "usebackq tokens=2 delims=:" %%a in (`ipconfig ^| findstr /r "[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*"`) do (
    set _temp=%%a
    rem remove leading space
    set _ipaddress=!_temp:~1!
    set _bad=0
    if [!_ipaddress:~-2!]==[.0] set _bad=1
    if [!_ipaddress:~-2!]==[.1] set _bad=1
    if [!_bad!]==[0] (
      if [!_alladdress!]==[] (
        set _alladdress=!_ipaddress!
      ) else (
        set _alladdress=!_alladdress!,!_ipaddress!
      )
    )  
  )
  
  set currentdir=%CD%
  set currentdir=%currentdir:\=/%
  set currentdir=%currentdir::=%
  set currentdir=//%currentdir%
  
  docker run --rm --name minifab -v /var/run/docker.sock:/var/run/docker.sock -v %CD%/vars:/home/vars ^
   -e "hostroot=%currentdir%" -e "ADDRS=!_alladdress!" hfrd/minifab:latest /home/main.sh %*

  endlocal
)
